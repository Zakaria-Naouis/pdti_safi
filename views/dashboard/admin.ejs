<!-- views/dashboard/admin.ejs - Version compl√®te CORRIG√âE -->

<% if (successMessage) { %>
<div class="alert alert-success alert-dismissible fade show" role="alert">
  <%= successMessage %>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<% } %>

<!-- Section: Statistiques globales -->
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-chart-bar me-2"></i>Statistiques globales</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body text-center">
                <i class="fas fa-project-diagram fa-2x mb-2"></i>
                <h5 class="card-title">Total Projets</h5>
                <h3 class="display-4"><%= stats.total_projets %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body text-center">
                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                <h5 class="card-title">Co√ªt Total</h5>
                <h3 class="display-4"><%= stats.cout_total.toFixed(2) %></h3>
                <small>MDH</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h5 class="card-title">Emplois Directs</h5>
                <h3 class="display-4"><%= stats.total_emplois %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-white">
              <div class="card-body text-center">
                <i class="fas fa-user-friends fa-2x mb-2"></i>
                <h5 class="card-title">B√©n√©ficiaires</h5>
                <h3 class="display-4"><%= stats.total_beneficiaires %></h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Section: Statistiques par P√¥le -->
<div class="row mt-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-building me-2"></i>Statistiques par P√¥le</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>P√¥le</th>
                <th class="text-center">Nombre de Projets</th>
                <th class="text-end">Co√ªt Total (MDH)</th>
                <th class="text-center">Emplois Directs</th>
                <th class="text-center">B√©n√©ficiaires</th>
              </tr>
            </thead>
            <tbody>
              <% polesStats.forEach(function(pole) { %>
              <tr>
                <td class="fw-bold"><%= pole.lib_pole %></td>
                <td class="text-center">
                  <span class="badge bg-primary rounded-pill"><%= pole.total_projets %></span>
                </td>
                <td class="text-end text-success fw-bold"><%= pole.cout_total.toFixed(2) %></td>
                <td class="text-center"><%= pole.total_emplois %></td>
                <td class="text-center"><%= pole.total_beneficiaires %></td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Section: Gestion des Projets -->
<div class="row mt-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-tasks me-2"></i>Gestion des Projets
        </h5>
        <div class="d-flex align-items-center">
          <span class="badge bg-light text-primary rounded-pill me-3 px-3 py-2">
            <i class="fas fa-hashtag me-1"></i><%= pagination.totalItems %> projets
          </span>
          <a href="/projects/add" class="btn btn-success">
            <i class="fas fa-plus me-1"></i> Ajouter un projet
          </a>
        </div>
      </div>
      <div class="card-body">
        <!-- Barre de recherche et filtres -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="fas fa-search"></i>
              </span>
              <input type="text" class="form-control" id="search-projects" placeholder="Rechercher par num√©ro, intitul√©...">
            </div>
          </div>

          <!-- FILTRE PAR AXE UNIQUEMENT -->
          <div class="col-md-4">
            <select class="form-select" id="filter-axe">
              <option value="">üéØ Tous les axes</option>
              <% if (typeof axes !== 'undefined' && axes && axes.length > 0) { %>
              <% axes.forEach(function(axe) { %>
              <option value="<%= axe.id %>">
                <%= axe.lib_pole %> - Axe <%= axe.id %>: <%= axe.lib_axe %>
              </option>
              <% }); %>
              <% } %>
            </select>
          </div>

          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" id="reset-filters-btn">
              <i class="fas fa-redo me-1"></i>R√©initialiser
            </button>
          </div>
        </div>

        <!-- Tableau des projets -->
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="projects-table">
            <thead class="table-light">
              <tr>
                <th>N¬∞</th>
                <th style="min-width: 250px;">Intitul√©</th>
                <th>P√¥le</th>
                <th>Axe</th>
                <th>Secteur</th>
                <th class="text-end">Co√ªt (MDH)</th>
                <th class="text-center">Emplois</th>
                <th class="text-center">B√©n√©ficiaires</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% projects.forEach(function(project) { %>
              <tr data-project-id="<%= project.id %>" data-axe-id="<%= project.axe_id %>" data-debug-axe="<%= project.axe_id %>">
                <!-- AJOUT d'un attribut de debug pour v√©rifier -->
                <td>
                  <span class="badge bg-primary fs-6"><%= project.num_projet %></span>
                </td>
                <td>
                  <a href="/projects/view/<%= project.id %>" class="text-decoration-none text-dark fw-bold">
                    <%= project.intitule.substring(0, 60) %><%= project.intitule.length > 60 ? '...' : '' %>
                  </a>
                </td>
                <td>
                  <small class="text-muted"><%= project.lib_pole %></small>
                </td>
                <td>
                  <small class="text-muted">Axe <%= project.axe_id %>: <%= project.lib_axe %></small>
                </td>
                <td>
                  <small class="text-muted"><%= project.lib_secteur %></small>
                </td>
                <td class="text-end">
                  <span class="fw-bold text-success">
                    <%= project.cout_total_mdh ? parseFloat(project.cout_total_mdh).toFixed(2) : '0.00' %>
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge bg-info"><%= project.nbr_emplois_directs || 0 %></span>
                </td>
                <td class="text-center">
                  <span class="badge bg-warning text-dark"><%= project.nbr_beneficiaires || 0 %></span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="/projects/view/<%= project.id %>" class="btn btn-outline-info" title="Consulter">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a href="/projects/edit/<%= project.id %>" class="btn btn-outline-primary" title="Modifier">
                      <i class="fas fa-edit"></i>
                    </a>
                    <button class="btn btn-outline-danger btn-delete-project" data-id="<%= project.id %>" data-title="<%= project.intitule %>" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <% }); %>

              <% if (projects.length === 0) { %>
              <tr id="empty-state-row">
                <td colspan="9" class="text-center py-5">
                  <i class="fas fa-folder-open text-muted" style="font-size: 4rem;"></i>
                  <p class="mt-3 text-muted fs-5">Aucun projet trouv√©</p>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if (pagination.totalPages > 1) { %>
        <nav aria-label="Pagination des projets" class="mt-4">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= !pagination.hasPrev ? 'disabled' : '' %>">
              <a class="page-link" href="?page=1" tabindex="-1">
                <i class="fas fa-angle-double-left"></i>
              </a>
            </li>
            <li class="page-item <%= !pagination.hasPrev ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>">
                <i class="fas fa-angle-left"></i> Pr√©c√©dent
              </a>
            </li>
            <% 
            let startPage = Math.max(1, pagination.currentPage - 2);
            let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
            
            if (startPage > 1) { %>
            <li class="page-item disabled"><span class="page-link">...</span></li>
            <% }
            
            for (let i = startPage; i <= endPage; i++) { %>
            <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>"><%= i %></a>
            </li>
            <% }
            
            if (endPage < pagination.totalPages) { %>
            <li class="page-item disabled"><span class="page-link">...</span></li>
            <% } %>
            <li class="page-item <%= !pagination.hasNext ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>">
                Suivant <i class="fas fa-angle-right"></i>
              </a>
            </li>
            <li class="page-item <%= !pagination.hasNext ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= pagination.totalPages %>">
                <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          </ul>
          <div class="text-center text-muted mt-2">
            Page <%= pagination.currentPage %> sur <%= pagination.totalPages %>
            (Total: <%= pagination.totalItems %> projets)
          </div>
        </nav>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirmer la suppression
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="fs-5">√ätes-vous s√ªr de vouloir supprimer ce projet ?</p>
        <div class="alert alert-warning">
          <strong id="projectTitle"></strong>
        </div>
        <p class="text-danger mb-0">
          <i class="fas fa-info-circle me-1"></i>
          <strong>Attention :</strong> Cette action est irr√©versible.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger" id="confirmDelete">
          <i class="fas fa-trash me-1"></i>Supprimer
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('=== D√âMARRAGE FILTRAGE ===');

    // DIAGNOSTIC COMPLET AU CHARGEMENT
    const allRows = document.querySelectorAll('#projects-table tbody tr[data-project-id]');
    console.log('üìä Nombre total de projets:', allRows.length);

    // Afficher tous les axe_id
    allRows.forEach((row, index) => {
      const axeId = row.getAttribute('data-axe-id');
      const projectId = row.getAttribute('data-project-id');
      console.log(`Projet ${index + 1}: ID=${projectId}, axe_id="${axeId}", type=${typeof axeId}`);
    });

    // Afficher les options du select
    const filterAxe = document.getElementById('filter-axe');
    if (filterAxe) {
      console.log('üìã Options du select:');
      Array.from(filterAxe.options).forEach(opt => {
        console.log(`  - Value: "${opt.value}", Text: ${opt.text}`);
      });
    }

    // VARIABLES
    const searchInput = document.getElementById('search-projects');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    let activeSearchTerm = '';
    let activeAxeFilter = '';

    // RECHERCHE
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        activeSearchTerm = this.value.toLowerCase().trim();
        applyFilters();
      });
    }

    // FILTRAGE PAR AXE
    if (filterAxe) {
      filterAxe.addEventListener('change', function() {
        activeAxeFilter = this.value;
        console.log('üéØ AXE S√âLECTIONN√â:', activeAxeFilter);
        applyFilters();
      });
    }

    // R√âINITIALISATION
    if (resetFiltersBtn) {
      resetFiltersBtn.addEventListener('click', function() {
        if (searchInput) searchInput.value = '';
        if (filterAxe) filterAxe.value = '';
        activeSearchTerm = '';
        activeAxeFilter = '';
        applyFilters();
        showToast('Filtres r√©initialis√©s', 'info');
      });
    }

    // FONCTION DE FILTRAGE
    function applyFilters() {
      console.log('--- APPLICATION FILTRES ---');
      console.log('Recherche:', activeSearchTerm);
      console.log('Axe:', activeAxeFilter);

      const rows = document.querySelectorAll('#projects-table tbody tr[data-project-id]');
      let visibleCount = 0;

      rows.forEach((row, index) => {
        let showRow = true;

        // Filtre recherche
        if (activeSearchTerm) {
          const text = row.textContent.toLowerCase();
          showRow = showRow && text.includes(activeSearchTerm);
        }

        // Filtre axe
        if (activeAxeFilter && activeAxeFilter !== '') {
          const rowAxeId = row.getAttribute('data-axe-id');

          // Conversion en string et suppression des espaces
          const normalizedRowAxeId = String(rowAxeId).trim();
          const normalizedFilterAxeId = String(activeAxeFilter).trim();

          const matches = normalizedRowAxeId === normalizedFilterAxeId;

          console.log(`Ligne ${index + 1}: "${normalizedRowAxeId}" === "${normalizedFilterAxeId}" ? ${matches}`);

          showRow = showRow && matches;
        }

        // Afficher/masquer
        if (showRow) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      console.log(`‚úÖ ${visibleCount} projet(s) visible(s)`);
      console.log('--- FIN FILTRAGE ---\n');

      updateNoResultsMessage(visibleCount);
    }

    // MESSAGE AUCUN R√âSULTAT
    function updateNoResultsMessage(visibleCount) {
      const tbody = document.querySelector('#projects-table tbody');
      let noResultsRow = tbody.querySelector('.no-results-row');

      if (visibleCount === 0) {
        const emptyStateRow = document.getElementById('empty-state-row');
        if (emptyStateRow) emptyStateRow.style.display = 'none';

        if (!noResultsRow) {
          noResultsRow = document.createElement('tr');
          noResultsRow.className = 'no-results-row';
          noResultsRow.innerHTML = `
            <td colspan="9" class="text-center py-5">
              <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
              <p class="mt-3 text-muted fs-5">Aucun projet trouv√©</p>
              <button class="btn btn-sm btn-outline-secondary" id="reset-from-msg">
                <i class="fas fa-redo me-1"></i>R√©initialiser
              </button>
            </td>
          `;
          tbody.appendChild(noResultsRow);
          document.getElementById('reset-from-msg').addEventListener('click', function() {
            resetFiltersBtn.click();
          });
        } else {
          noResultsRow.style.display = '';
        }
      } else {
        if (noResultsRow) noResultsRow.style.display = 'none';
      }
    }

    // SUPPRESSION
    const deleteButtons = document.querySelectorAll('.btn-delete-project');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    let projectIdToDelete = null;

    deleteButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        projectIdToDelete = this.getAttribute('data-id');
        document.getElementById('projectTitle').textContent = this.getAttribute('data-title');
        deleteModal.show();
      });
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
      if (!projectIdToDelete) return;
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Suppression...';

      fetch(`/projects/delete/${projectIdToDelete}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            deleteModal.hide();
            const row = document.querySelector(`tr[data-project-id="${projectIdToDelete}"]`);
            if (row) {
              row.style.opacity = '0';
              setTimeout(() => row.remove(), 300);
            }
            showToast('Projet supprim√©', 'success');
          } else {
            showToast('Erreur: ' + data.message, 'error');
          }
        })
        .catch(error => showToast('Erreur de suppression', 'error'))
        .finally(() => {
          const btn = document.getElementById('confirmDelete');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-trash me-1"></i>Supprimer';
          projectIdToDelete = null;
        });
    });

    // TOASTS
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container') || createToastContainer();
      const bgColors = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'info': 'bg-info'
      };
      const icons = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
      };

      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white ${bgColors[type]} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body"><i class="fas ${icons[type]} me-2"></i>${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;

      toastContainer.appendChild(toast);
      new bootstrap.Toast(toast, {
        delay: 3000
      }).show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '1055';
      document.body.appendChild(container);
      return container;
    }

    console.log('=== FILTRAGE PR√äT ===');
  });
</script>

<style>
  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }

  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: none;
  }

  tr {
    transition: opacity 0.3s ease;
  }
</style>