<!-- views/dashboard/admin.ejs - VERSION COMPL√àTE AVEC AFFICHAGE R√âORGANIS√â -->

<% if (successMessage) { %>
<div class="alert alert-success alert-dismissible fade show" role="alert">
  <%= successMessage %>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<% } %>

<!-- Section: Statistiques globales -->
<div class="row">
  <div class="col-md-12">
    <div class="card shadow-lg">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-globe me-2"></i>Statistiques Globales Hi√©rarchiques
          </h5>
          <span class="badge bg-light text-dark">
            <i class="fas fa-cube me-1"></i>Vision Compl√®te
          </span>
        </div>
      </div>

      <!-- TOTAUX GLOBAUX -->
      <div class="card-body bg-light">
        <div class="row mb-4">
          <div class="col-md-12">
            <h6 class="text-muted mb-3">
              <i class="fas fa-chart-pie me-2"></i>R√©sum√© Global
            </h6>
          </div>
          <% if (globalTotalStats) { %>
          <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
              <div class="card-body">
                <div class="text-primary text-uppercase mb-1">
                  <small><strong>Total Projets</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= globalTotalStats.nombre_projets %></strong>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
              <div class="card-body">
                <div class="text-success text-uppercase mb-1">
                  <small><strong>Co√ªt Total (MDH)</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= parseFloat(globalTotalStats.cout_total_mdh || 0).toFixed(2) %></strong>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
              <div class="card-body">
                <div class="text-info text-uppercase mb-1">
                  <small><strong>Emplois Directs</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= globalTotalStats.total_emplois_directs %></strong>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-left-warning shadow h-100 py-2">
              <div class="card-body">
                <div class="text-warning text-uppercase mb-1">
                  <small><strong>B√©n√©ficiaires</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= globalTotalStats.total_beneficiaires %></strong>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        </div>

        <!-- AXES R√âORGANIS√âS EN UNE LIGNE -->
        <div class="row mt-4">
          <div class="col-md-12">
            <h6 class="text-muted mb-3">
              <i class="fas fa-list-ul me-2"></i>D√©tails par Axe
            </h6>
          </div>
        </div>

        <div id="globalHierarchicalStatsContainer">
          <% if (globalHierarchy && globalHierarchy.length > 0) { %>
          <% globalHierarchy.forEach(function(axe, axeIndex) { 
              // COULEURS PAR AXE - Mapping exact
              let axeColor = '#666666';
              let axeColorLight = '#f8f8f8';
              let axeColorBorder = '#999999';
              
              const axeColorMap = {
                'Investissements et emplois': { main: '#BF9000', light: '#FFF8E7', border: '#D4A017' },
                'Renforcement et am√©lioration des services sociaux de base : Education': { main: '#DD6615', light: '#FFE8D6', border: '#E87E2E' },
                'Renforcement des services sociaux de base : Sant√©': { main: '#385623', light: '#E8F0E0', border: '#5A7A3D' },
                'Infrastructures de base et mise √† niveau': { main: '#595959', light: '#F0F0F0', border: '#808080' },
                'Gestion Proactive et durable des ressources en eau': { main: '#002060', light: '#E6E6F0', border: '#003399' }
              };
              
              for (const [axeName, colors] of Object.entries(axeColorMap)) {
                if (axe.axe_libelle && axe.axe_libelle.includes(axeName.split(':')[0])) {
                  axeColor = colors.main;
                  axeColorLight = colors.light;
                  axeColorBorder = colors.border;
                  break;
                }
              }
            %>

          <!-- LIGNE AXE R√âORGANIS√âE -->
          <div class="axe-stat-row mb-2" data-axe="<%= axeIndex + 1 %>" style="border-left-color: <%= axeColor %>;">
            <div class="axe-stat-content">
              <div class="axe-stat-left">
                <span class="axe-stat-icon"><%= ['üéØ', 'üéì', 'üè•', 'üíß', 'üèóÔ∏è'][axeIndex] %></span>
                <h6 class="axe-stat-title" style="color: <%= axeColor %>;"><%= axe.axe_libelle || 'Axe sans nom' %></h6>
              </div>

              <div class="axe-stat-actions">
                <div class="axe-stat-badges">
                  <span class="axe-stat-badge badge-projets" style="background-color: <%= axeColorLight %>; color: <%= axeColor %>;">
                    <i class="fas fa-folder"></i> <%= axe.stats.nombre_projets %>
                  </span>
                  <span class="axe-stat-badge badge-budget" style="background-color: <%= axeColorLight %>; color: <%= axeColor %>;">
                    <i class="fas fa-dollar-sign"></i> <%= parseFloat(axe.stats.cout_total_mdh || 0).toFixed(2) %> MDH
                  </span>
                  <span class="axe-stat-badge badge-conventions" style="background-color: <%= axeColorLight %>; color: <%= axeColor %>;">
                    <i class="fas fa-briefcase"></i> <%= axe.stats.total_emplois_directs %>
                  </span>
                  <span class="axe-stat-badge badge-beneficiaires" style="background-color: <%= axeColorLight %>; color: <%= axeColor %>;">
                    <i class="fas fa-users"></i> <%= axe.stats.total_beneficiaires %>
                  </span>
                </div>

                <button class="btn-export-axe export-axe-btn" data-axe-id="<%= axe.axe_id %>" style="background-color: <%= axeColor %>;">
                  <i class="fas fa-file-pdf"></i> Exporter Fiches Projets
                </button>

                <button class="btn-toggle-axe collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAxeGlobal<%= axeIndex %>" style="color: <%= axeColor %>;">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- CONTENU D√âTAILL√â DE L'AXE (COLLAPSIBLE) -->
          <div id="collapseAxeGlobal<%= axeIndex %>" class="collapse mb-3">
            <div class="card" style="border-left: 4px solid <%= axeColor %>; margin-left: 20px;">
              <div class="card-body p-0">
                <!-- TABLEAU DES SECTEURS -->
                <div class="table-responsive">
                  <table class="table table-sm table-striped mb-0">
                    <thead style="background-color: <%= axeColorLight %>;">
                      <tr>
                        <th style="width: 25%; color: <%= axeColor %>;"><strong>
                            <i class="fas fa-layer-group me-2"></i>Secteur
                          </strong></th>
                        <th class="text-center" style="width: 12%; color: <%= axeColor %>;"><strong>
                            <i class="fas fa-cubes me-1"></i>Projets
                          </strong></th>
                        <th class="text-center" style="width: 18%; color: <%= axeColor %>;"><strong>
                            <i class="fas fa-dollar-sign me-1"></i>Montant (MDH)
                          </strong></th>
                        <th class="text-center" style="width: 12%; color: <%= axeColor %>;"><strong>
                            <i class="fas fa-briefcase me-1"></i>Emplois
                          </strong></th>
                        <th class="text-center" style="width: 18%; color: <%= axeColor %>;"><strong>
                            <i class="fas fa-users me-1"></i>B√©n√©ficiaires
                          </strong></th>
                        <th class="text-center" style="width: 15%;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (axe.secteurs && axe.secteurs.length > 0) { %>
                      <% axe.secteurs.forEach(function(secteur, secteurIndex) { %>
                      <!-- Ligne Secteur -->
                      <tr class="secteur-row-themed" data-axe-id="<%= axe.axe_id %>" data-secteur-id="<%= secteur.secteur_id %>" role="button">
                        <td class="secteur-toggle-themed">
                          <strong style="color: <%= axeColor %>;">
                            <i class="fas fa-caret-right secteur-icon-themed me-2" style="color: <%= axeColor %>;"></i>
                            <%= secteur.secteur_libelle || 'Secteur sans nom' %>
                          </strong>
                        </td>
                        <td class="text-center"><strong><%= secteur.stats.nombre_projets %></strong></td>
                        <td class="text-center"><strong><%= parseFloat(secteur.stats.cout_total_mdh || 0).toFixed(2) %></strong></td>
                        <td class="text-center"><strong><%= secteur.stats.total_emplois_directs %></strong></td>
                        <td class="text-center"><strong><%= secteur.stats.total_beneficiaires %></strong></td>
                        <td class="text-center">
                          <button class="btn btn-sm secteur-collapse-btn-themed" data-axe-id="<%= axe.axe_id %>" data-secteur-id="<%= secteur.secteur_id %>" style="background-color: <%= axeColor %>; color: white; border: none;">
                            <i class="fas fa-chevron-down"></i>
                          </button>
                        </td>
                      </tr>

                      <!-- D√©tails Objectifs -->
                      <tr class="objectif-details-themed" id="details-themed-axe<%= axe.axe_id %>-secteur<%= secteur.secteur_id %>" style="display: none;">
                        <td colspan="6" class="p-0">
                          <div style="background-color: <%= axeColorLight %>; padding: 10px;">
                            <table class="table table-bordered table-sm mb-0" style="font-size: 0.9em;">
                              <thead style="background-color: white;">
                                <tr>
                                  <th style="width: 25%; color: <%= axeColor %>;"><i class="fas fa-tasks me-1"></i>Objectif</th>
                                  <th class="text-center" style="width: 12%; color: <%= axeColor %>;">Projets</th>
                                  <th class="text-center" style="width: 18%; color: <%= axeColor %>;">Montant (MDH)</th>
                                  <th class="text-center" style="width: 12%; color: <%= axeColor %>;">Emplois</th>
                                  <th class="text-center" style="width: 18%; color: <%= axeColor %>;">B√©n√©ficiaires</th>
                                  <th class="text-center" style="width: 15%;"></th>
                                </tr>
                              </thead>
                              <tbody>
                                <% if (secteur.objectifs && secteur.objectifs.length > 0) { %>
                                <% secteur.objectifs.forEach(function(objectif) { %>
                                <tr class="objectif-row-themed" style="background-color: white;">
                                  <td><i class="fas fa-angle-double-right me-2" style="color: <%= axeColor %>;"></i><%= objectif.objectif_libelle || 'Objectif sans nom' %></td>
                                  <td class="text-center"><%= objectif.nombre_projets %></td>
                                  <td class="text-center"><%= parseFloat(objectif.cout_total_mdh || 0).toFixed(2) %></td>
                                  <td class="text-center"><%= objectif.total_emplois_directs %></td>
                                  <td class="text-center"><%= objectif.total_beneficiaires %></td>
                                  <td class="text-center">
                                    <a href="/projects?axe=<%= axe.axe_id %>&secteur=<%= secteur.secteur_id %>&objectif=<%= objectif.objectif_id %>" class="btn btn-sm" style="background-color: <%= axeColor %>; color: white;">
                                      <i class="fas fa-eye"></i> Voir
                                    </a>
                                  </td>
                                </tr>
                                <% }); %>
                                <% } else { %>
                                <tr>
                                  <td colspan="6" class="text-center text-muted"><em>Aucun objectif</em></td>
                                </tr>
                                <% } %>
                              </tbody>
                            </table>
                          </div>
                        </td>
                      </tr>
                      <% }); %>
                      <% } else { %>
                      <tr>
                        <td colspan="6" class="text-center text-muted"><em>Aucun secteur</em></td>
                      </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <% }); %>
          <% } else { %>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>Aucune donn√©e hi√©rarchique disponible
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ ANCRE : La page reviendra √† cet endroit apr√®s pagination -->
<div id="gestion-projets"></div>

<!-- Section: Gestion des Projets -->
<div class="row mt-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-tasks me-2"></i>Gestion des Projets
        </h5>
        <div class="d-flex align-items-center">
          <span class="badge bg-light text-primary rounded-pill me-3 px-3 py-2">
            <i class="fas fa-hashtag me-1"></i><%= pagination.totalItems %> projets
          </span>
          <a href="/projects/add" class="btn btn-success">
            <i class="fas fa-plus me-1"></i> Ajouter un projet
          </a>
        </div>
      </div>
      <div class="card-body">
        <!-- Barre de recherche et filtres -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text bg-light">
                <i class="fas fa-search"></i>
              </span>
              <input type="text" class="form-control" id="search-projects" placeholder="Rechercher par num√©ro, intitul√©...">
            </div>
          </div>

          <div class="col-md-4">
            <select class="form-select" id="filter-axe">
              <option value="">üéØ Tous les axes</option>
              <% if (typeof axes !== 'undefined' && axes && axes.length > 0) { %>
              <% axes.forEach(function(axe) { %>
              <option value="<%= axe.id %>" <%= currentAxeFilter == axe.id ? 'selected' : '' %>>
                Axe <%= axe.id %> : <%- axe.lib_axe %>
              </option>
              <% }); %>
              <% } %>
            </select>
          </div>

          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" id="reset-filters-btn">
              <i class="fas fa-redo me-1"></i>R√©initialiser
            </button>
          </div>
        </div>

        <!-- Tableau des projets -->
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="projects-table">
            <thead class="table-light">
              <tr>
                <th>N¬∞</th>
                <th style="min-width: 250px;">Intitul√©</th>
                <th>P√¥le</th>
                <th>Axe</th>
                <th>Secteur</th>
                <th class="text-end">Co√ªt (MDH)</th>
                <th class="text-center">Emplois</th>
                <th class="text-center">B√©n√©ficiaires</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% projects.forEach(function(project) { %>
              <tr data-project-id="<%= project.id %>" data-axe-id="<%= project.axe_id %>">
                <td>
                  <span class="badge bg-primary fs-6"><%= project.num_projet %></span>
                </td>
                <td>
                  <a href="/projects/view/<%= project.id %>" class="text-decoration-none text-dark fw-bold">
                    <%- project.intitule.substring(0, 60) %><%= project.intitule.length > 60 ? '...' : '' %>
                  </a>
                </td>
                <td>
                  <small class="text-muted"><%- project.lib_pole %></small>
                </td>
                <td>
                  <small class="text-muted">Axe <%= project.axe_id %></small>
                </td>
                <td>
                  <small class="text-muted"><%- project.lib_secteur %></small>
                </td>
                <td class="text-end">
                  <span class="fw-bold text-success">
                    <%= project.cout_total_mdh ? parseFloat(project.cout_total_mdh).toFixed(2) : '0.00' %>
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge bg-info"><%= project.nbr_emplois_directs || 0 %></span>
                </td>
                <td class="text-center">
                  <span class="badge bg-warning text-dark"><%= project.nbr_beneficiaires || 0 %></span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="/projects/view/<%= project.id %>" class="btn btn-outline-info" title="Consulter">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a href="/projects/edit/<%= project.id %>" class="btn btn-outline-primary" title="Modifier">
                      <i class="fas fa-edit"></i>
                    </a>
                    <button class="btn btn-outline-danger btn-delete-project" data-id="<%= project.id %>" data-title="<%- project.intitule %>" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if (pagination && pagination.totalPages > 1) { %>
        <nav aria-label="Pagination des projets" class="mt-4">
          <%
          function buildPageUrl(pageNum) {
            let url = '?page=' + pageNum;
            if (currentAxeFilter) {
              url += '&axe=' + currentAxeFilter;
            }
            url += '#gestion-projets';
            return url;
          }
          %>

          <ul class="pagination justify-content-center">
            <li class="page-item <%= !pagination.hasPrev ? 'disabled' : '' %>">
              <a class="page-link" href="<%= buildPageUrl(1) %>" tabindex="-1">
                <i class="fas fa-angle-double-left"></i>
              </a>
            </li>
            <li class="page-item <%= !pagination.hasPrev ? 'disabled' : '' %>">
              <a class="page-link" href="<%= buildPageUrl(pagination.currentPage - 1) %>">
                <i class="fas fa-angle-left"></i> Pr√©c√©dent
              </a>
            </li>
            <% 
            let startPage = Math.max(1, pagination.currentPage - 2);
            let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
            
            if (startPage > 1) { %>
            <li class="page-item disabled"><span class="page-link">...</span></li>
            <% }
            
            for (let i = startPage; i <= endPage; i++) { %>
            <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
              <a class="page-link" href="<%= buildPageUrl(i) %>"><%= i %></a>
            </li>
            <% }
            
            if (endPage < pagination.totalPages) { %>
            <li class="page-item disabled"><span class="page-link">...</span></li>
            <% } %>
            <li class="page-item <%= !pagination.hasNext ? 'disabled' : '' %>">
              <a class="page-link" href="<%= buildPageUrl(pagination.currentPage + 1) %>">
                Suivant <i class="fas fa-angle-right"></i>
              </a>
            </li>
            <li class="page-item <%= !pagination.hasNext ? 'disabled' : '' %>">
              <a class="page-link" href="<%= buildPageUrl(pagination.totalPages) %>">
                <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          </ul>
        </nav>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Modal de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirmer la suppression
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>√ätes-vous s√ªr de vouloir supprimer le projet suivant ?</p>
        <p class="fw-bold" id="projectTitle"></p>
        <p class="text-danger"><small>Cette action est irr√©versible.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">
          <i class="fas fa-trash me-1"></i>Supprimer
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation Dashboard Admin');

    // ========== EXPORT FICHES PROJETS PAR AXE ==========
    const exportAxeButtons = document.querySelectorAll('.export-axe-btn');
    exportAxeButtons.forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.stopPropagation();
        const axeId = this.getAttribute('data-axe-id');

        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Export...';
        this.disabled = true;

        try {
          const response = await fetch(`/export/fiches-projets/${axeId}`);

          if (!response.ok) throw new Error('Erreur export');

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Fiches_Projets_Axe${axeId}_${new Date().toISOString().split('T')[0]}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();

        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de l\'export');
        } finally {
          this.innerHTML = originalText;
          this.disabled = false;
        }
      });
    });

    // ========== TOGGLE DES AXES (CHEVRON) ==========
    const axeToggleButtons = document.querySelectorAll('.btn-toggle-axe');
    axeToggleButtons.forEach(button => {
      const target = button.getAttribute('data-bs-target');
      const collapseElement = document.querySelector(target);

      if (collapseElement) {
        collapseElement.addEventListener('show.bs.collapse', function() {
          button.classList.remove('collapsed');
          button.querySelector('i').classList.remove('fa-chevron-down');
          button.querySelector('i').classList.add('fa-chevron-up');
        });

        collapseElement.addEventListener('hide.bs.collapse', function() {
          button.classList.add('collapsed');
          button.querySelector('i').classList.remove('fa-chevron-up');
          button.querySelector('i').classList.add('fa-chevron-down');
        });
      }
    });

    // ========== D√âPLIANT DES SECTEURS ==========
    const secteurCollapseButtons = document.querySelectorAll('.secteur-collapse-btn-themed');
    secteurCollapseButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.stopPropagation();

        const axeId = this.getAttribute('data-axe-id');
        const secteurId = this.getAttribute('data-secteur-id');
        const detailsId = `details-themed-axe${axeId}-secteur${secteurId}`;
        const detailsRow = document.getElementById(detailsId);
        const sectionRow = this.closest('.secteur-row-themed');
        const icon = this.querySelector('i');
        const secteurIcon = sectionRow.querySelector('.secteur-icon-themed');

        if (detailsRow) {
          const isVisible = detailsRow.style.display !== 'none';
          detailsRow.style.display = isVisible ? 'none' : 'table-row';

          if (isVisible) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            sectionRow.classList.remove('expanded');
            if (secteurIcon) {
              secteurIcon.classList.remove('fa-caret-down');
              secteurIcon.classList.add('fa-caret-right');
            }
          } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            sectionRow.classList.add('expanded');
            if (secteurIcon) {
              secteurIcon.classList.remove('fa-caret-right');
              secteurIcon.classList.add('fa-caret-down');
            }
          }
        }
      });
    });

    // ========== CLIC SUR LIGNE SECTEUR ==========
    const toggles = document.querySelectorAll('.secteur-toggle-themed');
    toggles.forEach(toggle => {
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const button = this.closest('.secteur-row-themed').querySelector('.secteur-collapse-btn-themed');
        if (button) button.click();
      });
    });

    // ========== FILTRE PAR AXE ==========
    const filterAxe = document.getElementById('filter-axe');
    if (filterAxe) {
      filterAxe.addEventListener('change', function() {
        const selectedAxe = this.value;
        let url = window.location.pathname;

        if (selectedAxe) {
          url += '?axe=' + selectedAxe;
        }

        url += '#gestion-projets';
        window.location.href = url;
      });
    }

    // ========== BOUTON R√âINITIALISER ==========
    const resetBtn = document.getElementById('reset-filters-btn');
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        window.location.href = window.location.pathname + '#gestion-projets';
      });
    }

    // ========== RECHERCHE C√îT√â CLIENT ==========
    const searchInput = document.getElementById('search-projects');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#projects-table tbody tr[data-project-id]');

        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          if (text.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
    }

    // ========== SUPPRESSION DE PROJET ==========
    const deleteButtons = document.querySelectorAll('.btn-delete-project');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    let projectIdToDelete = null;

    deleteButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        projectIdToDelete = this.getAttribute('data-id');
        document.getElementById('projectTitle').textContent = this.getAttribute('data-title');
        deleteModal.show();
      });
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
      if (!projectIdToDelete) return;

      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Suppression...';

      fetch(`/projects/delete/${projectIdToDelete}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            deleteModal.hide();
            window.location.href = window.location.href;
          } else {
            alert('Erreur: ' + data.message);
          }
        })
        .catch(error => alert('Erreur de suppression'))
        .finally(() => {
          const btn = document.getElementById('confirmDelete');
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-trash me-1"></i>Supprimer';
          projectIdToDelete = null;
        });
    });

    console.log('‚úÖ Dashboard Admin initialis√©');
  });
</script>

<style>
  /* ========== R√âORGANISATION DES D√âTAILS PAR AXE ========== */
  .axe-stat-row {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    background: #fff;
    border-left: 4px solid;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  .axe-stat-row:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    transform: translateX(3px);
  }

  .axe-stat-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    gap: 15px;
  }

  .axe-stat-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 0 0 auto;
  }

  .axe-stat-icon {
    font-size: 22px;
  }

  .axe-stat-title {
    font-weight: 600;
    font-size: 15px;
    margin: 0;
  }

  .axe-stat-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
  }

  .axe-stat-badges {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .axe-stat-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
  }

  .btn-export-axe {
    padding: 6px 14px;
    font-size: 13px;
    border-radius: 6px;
    border: none;
    color: white;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
  }

  .btn-export-axe:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }

  .btn-toggle-axe {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    transition: transform 0.3s ease;
  }

  .btn-toggle-axe:hover {
    opacity: 0.7;
  }

  .btn-toggle-axe.collapsed i {
    transform: rotate(0deg);
  }

  .btn-toggle-axe:not(.collapsed) i {
    transform: rotate(180deg);
  }

  /* ========== STYLES SECTEURS ET OBJECTIFS ========== */
  .secteur-row-themed {
    background-color: #fafbfc;
    border-left: 4px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .secteur-row-themed:hover {
    background-color: #f0f5fb;
    border-left-width: 6px;
  }

  .secteur-icon-themed {
    transition: transform 0.3s ease;
    display: inline-block;
  }

  .secteur-row-themed.expanded .secteur-icon-themed {
    transform: rotate(90deg);
  }

  .objectif-details-themed {
    transition: all 0.3s ease;
  }

  .objectif-row-themed:hover {
    background-color: rgba(255, 255, 255, 0.5) !important;
  }

  .secteur-collapse-btn-themed {
    border: 1px solid;
    background: white;
    transition: all 0.2s ease;
  }

  .secteur-collapse-btn-themed:hover {
    background-color: rgba(0, 0, 0, 0.05);
    transform: scale(1.1);
  }

  /* ========== STYLES G√âN√âRAUX ========== */
  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }

  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: none;
  }

  html {
    scroll-behavior: smooth;
  }

  #gestion-projets {
    scroll-margin-top: 20px;
  }

  .border-left-primary {
    border-left: 4px solid #4e73df !important;
  }

  .border-left-success {
    border-left: 4px solid #1cc88a !important;
  }

  .border-left-info {
    border-left: 4px solid #36b9cc !important;
  }

  .border-left-warning {
    border-left: 4px solid #f6c23e !important;
  }

  /* ========== RESPONSIVE ========== */
  @media (max-width: 992px) {
    .axe-stat-content {
      flex-wrap: wrap;
    }

    .axe-stat-actions {
      width: 100%;
      justify-content: space-between;
      margin-top: 10px;
    }

    .axe-stat-badges {
      flex-wrap: wrap;
    }
  }
</style>