<!-- views/dashboard/gouverneur.ejs - Version modifiée avec panneaux d'axes et gestion des instructions -->

<!--<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5>Statistiques globales</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <h5 class="card-title">Total Projets</h5>
                <h3><%= stats.total_projets %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body">
                <h5 class="card-title">Coût Total (MDH)</h5>
                <h3><%= stats.cout_total.toFixed(2) %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body">
                <h5 class="card-title">Emplois Directs</h5>
                <h3><%= stats.total_emplois %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-white">
              <div class="card-body">
                <h5 class="card-title">Bénéficiaires</h5>
                <h3><%= stats.total_beneficiaires %></h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--<div class="row mt-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5>Statistiques par Pôle</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Pôle</th>
                <th>Nombre de Projets</th>
                <th>Coût Total (MDH)</th>
                <th>Emplois Directs</th>
                <th>Bénéficiaires</th>
              </tr>
            </thead>
            <tbody>
              <% polesStats.forEach(function(pole) { %>
              <tr>
                <td><%= pole.lib_pole %></td>
                <td><%= pole.total_projets %></td>
                <td><%= pole.cout_total.toFixed(2) %></td>
                <td><%= pole.total_emplois %></td>
                <td><%= pole.total_beneficiaires %></td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>-->
<!--******************************************Statistiques par Axes,Secteurs et Objectifs **********************-->
<!-- ================================================================ -->
<!-- VUE GOUVERNEUR AVEC THEMING PAR AXE -->
<!-- Chaque axe a sa propre couleur de thème -->
<!-- ================================================================ -->

<div class="row mt-1 mb-5">
  <div class="col-md-12">
    <div class="card shadow-lg">
      <div class="card-header bg-dark text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-globe me-2"></i>Statistiques Globales Hiérarchiques
          </h5>
          <span class="badge bg-light text-dark">
            <i class="fas fa-cube me-1"></i>Vision Complète
          </span>
        </div>
      </div>

      <!-- TOTAUX GLOBAUX -->
      <div class="card-body bg-light">
        <div class="row mb-4">
          <div class="col-md-12">
            <h6 class="text-muted mb-3">
              <i class="fas fa-chart-pie me-2"></i>Résumé Global
            </h6>
          </div>
          <% if (globalTotalStats) { %>
          <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
              <div class="card-body">
                <div class="text-primary text-uppercase mb-1">
                  <small><strong>Total Projets</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= globalTotalStats.nombre_projets %></strong>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
              <div class="card-body">
                <div class="text-success text-uppercase mb-1">
                  <small><strong>Coût Total (MDH)</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= globalTotalStats.cout_total_mdh.toFixed(2) %></strong>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-left-info shadow h-100 py-2">
              <div class="card-body">
                <div class="text-info text-uppercase mb-1">
                  <small><strong>Emplois Directs</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= globalTotalStats.total_emplois_directs %></strong>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-left-warning shadow h-100 py-2">
              <div class="card-body">
                <div class="text-warning text-uppercase mb-1">
                  <small><strong>Bénéficiaires</strong></small>
                </div>
                <div class="h3 mb-0">
                  <strong><%= globalTotalStats.total_beneficiaires %></strong>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        </div>

        <!-- AXES DÉPLIANTS THÉMATISÉS -->
        <div class="row mt-4">
          <div class="col-md-12">
            <h6 class="text-muted mb-3">
              <i class="fas fa-list-ul me-2"></i>Détails par Axe
            </h6>
          </div>
        </div>

        <div id="globalHierarchicalStatsContainer">
          <% if (globalHierarchy && globalHierarchy.length > 0) { %>
          <% globalHierarchy.forEach(function(axe, axeIndex) { 
              // COULEURS PAR AXE - Mapping exact
              let axeColor = '#666666'; // Couleur par défaut
              let axeColorLight = '#f8f8f8';
              let axeColorBorder = '#999999';
              
              const axeColorMap = {
                'Investissements et emplois': { main: '#BF9000', light: '#FFF8E7', border: '#D4A017' },
                'Renforcement et amélioration des services sociaux de base : Education': { main: '#DD6615', light: '#FFE8D6', border: '#E87E2E' },
                'Renforcement des services sociaux de base : Santé': { main: '#385623', light: '#E8F0E0', border: '#5A7A3D' },
                'Infrastructures de base et mise à niveau': { main: '#595959', light: '#F0F0F0', border: '#808080' },
                'Gestion Proactive et durable des ressources en eau': { main: '#002060', light: '#E6E6F0', border: '#003399' }
              };
              
              // Chercher la couleur correspondante
              for (const [axeName, colors] of Object.entries(axeColorMap)) {
                if (axe.axe_libelle && axe.axe_libelle.includes(axeName.split(':')[0])) {
                  axeColor = colors.main;
                  axeColorLight = colors.light;
                  axeColorBorder = colors.border;
                  break;
                }
              }
            %>
          <!-- ========== PANNEAU AXE THÉMATISÉ ========== -->
          <div class="accordion mb-3 axe-themed" id="accordionAxeGlobal<%= axeIndex %>" style="border-left: 5px solid <%= axeColor %>;">
            <div class="accordion-item" style="border: 1px solid <%= axeColorBorder %>;">
              <h2 class="accordion-header" id="headingAxeGlobal<%= axeIndex %>">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAxeGlobal<%= axeIndex %>" aria-expanded="false" aria-controls="collapseAxeGlobal<%= axeIndex %>" style="background-color: <%= axeColorLight %>; border-bottom: 2px solid <%= axeColor %>;">

                  <div class="d-flex justify-content-between align-items-center w-100">
                    <span>
                      <i class="fas fa-arrow-right me-2 axe-icon-global" style="color: <%= axeColor %>;"></i>
                      <strong style="color: <%= axeColor %>;">
                        <%= axe.axe_libelle || 'Axe sans nom' %>
                      </strong>
                      <span class="badge ms-2" style="background-color: <%= axeColor %>;">
                        <%= axe.pole_libelle %>
                      </span>
                    </span>
                    <div class="stats-badges-global ms-auto">
                      <span class="badge me-2" style="background-color: <%= axeColor %>;">
                        <i class="fas fa-cubes me-1"></i><strong><%= axe.stats.nombre_projets %></strong>
                      </span>
                      <span class="badge me-2" style="background-color: <%= axeColor %>; opacity: 0.8;">
                        <i class="fas fa-dollar-sign me-1"></i><strong><%= axe.stats.cout_total_mdh.toFixed(2) %></strong> MDH
                      </span>
                      <span class="badge me-2" style="background-color: <%= axeColor %>; opacity: 0.9;">
                        <i class="fas fa-briefcase me-1"></i><strong><%= axe.stats.total_emplois_directs %></strong>
                      </span>
                      <span class="badge" style="background-color: <%= axeColor %>; opacity: 0.85;">
                        <i class="fas fa-users me-1"></i><strong><%= axe.stats.total_beneficiaires %></strong>
                      </span>
                    </div>
                  </div>
                </button>
              </h2>

              <div id="collapseAxeGlobal<%= axeIndex %>" class="accordion-collapse collapse" aria-labelledby="headingAxeGlobal<%= axeIndex %>" data-bs-parent="#accordionAxeGlobal<%= axeIndex %>">
                <div class="accordion-body p-0">
                  <!-- ========== TABLEAU DES SECTEURS ========== -->
                  <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0 table-themed" style="--theme-color: <%= axeColor %>;">
                      <thead style="background-color: <%= axeColorLight %>; border-top: 3px solid <%= axeColor %>;">
                        <tr>
                          <th style="width: 25%; color: <%= axeColor %>;"><strong>
                              <i class="fas fa-layer-group me-2"></i>Secteur
                            </strong></th>
                          <th class="text-center" style="width: 12%; color: <%= axeColor %>;"><strong>
                              <i class="fas fa-cubes me-1"></i>Projets
                            </strong></th>
                          <th class="text-center" style="width: 18%; color: <%= axeColor %>;"><strong>
                              <i class="fas fa-dollar-sign me-1"></i>Montant (MDH)
                            </strong></th>
                          <th class="text-center" style="width: 12%; color: <%= axeColor %>;"><strong>
                              <i class="fas fa-briefcase me-1"></i>Emplois
                            </strong></th>
                          <th class="text-center" style="width: 18%; color: <%= axeColor %>;"><strong>
                              <i class="fas fa-users me-1"></i>Bénéficiaires
                            </strong></th>
                          <th class="text-center" style="width: 15%;"></th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (axe.secteurs && axe.secteurs.length > 0) { %>
                        <% axe.secteurs.forEach(function(secteur, secteurIndex) { %>
                        <!-- Ligne Secteur (dépliable) -->
                        <tr class="secteur-row-themed" data-axe="<%= axeIndex %>" data-secteur="<%= secteurIndex %>" data-theme-color="<%= axeColor %>" role="button">
                          <td>
                            <span class="secteur-toggle-themed cursor-pointer">
                              <i class="fas fa-chevron-right me-2 secteur-icon-themed" style="color: <%= axeColor %>;"></i>
                              <strong><%= secteur.secteur_libelle || 'Secteur sans nom' %></strong>
                            </span>
                          </td>
                          <td class="text-center">
                            <span class="badge" style="background-color: <%= axeColor %>;">
                              <%= secteur.stats.nombre_projets %>
                            </span>
                          </td>
                          <td class="text-center">
                            <strong style="color: <%= axeColor %>;">
                              <%= secteur.stats.cout_total_mdh.toFixed(2) %>
                            </strong>
                          </td>
                          <td class="text-center">
                            <span class="badge" style="background-color: <%= axeColor %>; opacity: 0.8;">
                              <%= secteur.stats.total_emplois_directs %>
                            </span>
                          </td>
                          <td class="text-center">
                            <span class="badge" style="background-color: <%= axeColor %>; opacity: 0.85;">
                              <%= secteur.stats.total_beneficiaires %>
                            </span>
                          </td>
                          <td class="text-center">
                            <button class="btn btn-sm secteur-collapse-btn-themed" data-secteur-id="<%= secteurIndex %>" data-axe-id="<%= axeIndex %>" style="border-color: <%= axeColor %>; color: <%= axeColor %>;">
                              <i class="fas fa-chevron-down"></i>
                            </button>
                          </td>
                        </tr>

                        <!-- ========== DÉTAIL OBJECTIFS ========== -->
                        <tr class="objectif-details-themed" id="details-themed-axe<%= axeIndex %>-secteur<%= secteurIndex %>" style="display: none; background-color: <%= axeColorLight %>;">
                          <td colspan="6" class="p-3">
                            <div class="objectifs-list">
                              <% if (secteur.objectifs && secteur.objectifs.length > 0) { %>
                              <div class="mb-2">
                                <h6 style="color: <%= axeColor %>;">
                                  <i class="fas fa-bullseye me-2"></i><strong>Objectifs</strong>
                                  <span class="badge" style="background-color: <%= axeColor %>;">
                                    <%= secteur.objectifs.length %>
                                  </span>
                                </h6>
                              </div>
                              <table class="table table-sm table-borderless mb-0">
                                <thead>
                                  <tr style="border-bottom: 2px solid <%= axeColor %>;">
                                    <th style="width: 25%; padding-left: 30px; color: <%= axeColor %>;"><strong>Objectif</strong></th>
                                    <th class="text-center" style="width: 12%; color: <%= axeColor %>;"><strong>Projets</strong></th>
                                    <th class="text-center" style="width: 18%; color: <%= axeColor %>;"><strong>Montant (MDH)</strong></th>
                                    <th class="text-center" style="width: 12%; color: <%= axeColor %>;"><strong>Emplois</strong></th>
                                    <th class="text-center" style="width: 18%; color: <%= axeColor %>;"><strong>Bénéficiaires</strong></th>
                                    <th class="text-center" style="width: 15%; color: <%= axeColor %>;"><strong>% Secteur</strong></th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <% secteur.objectifs.forEach(function(objectif) { 
                                              const pctMontant = secteur.stats.cout_total_mdh > 0 ? 
                                                ((objectif.cout_total_mdh / secteur.stats.cout_total_mdh) * 100).toFixed(1) : 0;
                                            %>
                                  <tr class="objectif-row-themed" style="border-bottom: 1px solid <%= axeColorBorder %>;">
                                    <td style="padding-left: 50px;">
                                      <i class="fas fa-circle me-2" style="font-size: 8px; color: <%= axeColor %>;"></i>
                                      <span class="objectif-name" style="color: #333;">
                                        <%= objectif.objectif_libelle || 'Objectif sans nom' %>
                                      </span>
                                    </td>
                                    <td class="text-center">
                                      <span class="badge" style="background-color: <%= axeColor %>;">
                                        <%= objectif.nombre_projets %>
                                      </span>
                                    </td>
                                    <td class="text-center">
                                      <strong style="color: <%= axeColor %>;">
                                        <%= objectif.cout_total_mdh.toFixed(2) %>
                                      </strong>
                                    </td>
                                    <td class="text-center">
                                      <span class="badge" style="background-color: <%= axeColor %>; opacity: 0.8;">
                                        <%= objectif.total_emplois_directs %>
                                      </span>
                                    </td>
                                    <td class="text-center">
                                      <span class="badge" style="background-color: <%= axeColor %>; opacity: 0.85;">
                                        <%= objectif.total_beneficiaires %>
                                      </span>
                                    </td>
                                    <td class="text-center">
                                      <small style="color: <%= axeColor %>; font-weight: bold;">
                                        <%= pctMontant %>%
                                      </small>
                                    </td>
                                  </tr>
                                  <% }); %>
                                </tbody>
                              </table>
                              <% } else { %>
                              <div class="alert alert-info mb-0" style="border-left: 4px solid <%= axeColor %>;">
                                <i class="fas fa-info-circle me-2"></i>
                                Aucun objectif défini pour ce secteur
                              </div>
                              <% } %>
                            </div>
                          </td>
                        </tr>
                        <% }); %>
                        <% } else { %>
                        <tr>
                          <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox me-2"></i>Aucun secteur pour cet axe
                          </td>
                        </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <% }); %>
          <% } else { %>
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Aucune donnée de statistiques disponible
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================================================================ -->
<!-- STYLES CSS THÉMATISÉS -->
<!-- ================================================================ -->
<style>
  /* Conteneur général */
  #globalHierarchicalStatsContainer {
    opacity: 0;
    animation: fadeInThemed 0.5s ease-in-out forwards;
  }

  @keyframes fadeInThemed {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Panneaux thématisés */
  .axe-themed {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .axe-themed:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .accordion-item {
    border: none;
    background: white;
  }

  .accordion-button {
    font-size: 0.95rem;
    padding: 1rem 1.5rem;
    transition: all 0.3s ease;
  }

  .accordion-button:not(.collapsed) {
    box-shadow: none;
  }

  .accordion-button:focus {
    box-shadow: none;
  }

  /* Icônes d'expansion */
  .axe-icon-global {
    transition: transform 0.3s ease;
    display: inline-block;
  }

  .accordion-button:not(.collapsed) .axe-icon-global {
    transform: rotate(90deg);
  }

  /* Lignes des secteurs */
  .secteur-row-themed {
    background-color: #fafbfc;
    border-left: 4px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .secteur-row-themed:hover {
    background-color: #f0f5fb;
    border-left-width: 6px;
  }

  .secteur-toggle-themed {
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .secteur-toggle-themed:hover {
    font-weight: 600;
  }

  .secteur-icon-themed {
    transition: transform 0.3s ease;
    display: inline-block;
  }

  .secteur-row-themed.expanded .secteur-icon-themed {
    transform: rotate(90deg);
  }

  /* Détails objectifs */
  .objectif-details-themed {
    transition: all 0.3s ease;
    animation: slideDownThemed 0.3s ease;
  }

  @keyframes slideDownThemed {
    from {
      opacity: 0;
      max-height: 0;
    }

    to {
      opacity: 1;
      max-height: 1000px;
    }
  }

  .objectif-row-themed {
    transition: background-color 0.2s ease;
  }

  .objectif-row-themed:hover {
    background-color: rgba(255, 255, 255, 0.5) !important;
  }

  /* Boutons thématisés */
  .secteur-collapse-btn-themed {
    border: 1px solid;
    background: white;
    transition: all 0.2s ease;
  }

  .secteur-collapse-btn-themed:hover {
    background-color: rgba(0, 0, 0, 0.05);
    transform: scale(1.1);
  }

  /* Badges avec opacité */
  .badge {
    transition: all 0.2s ease;
  }

  .badge:hover {
    opacity: 1 !important;
    transform: scale(1.05);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .stats-badges-global {
      flex-direction: column;
      gap: 0.4rem;
    }

    .accordion-button {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
    }

    .table {
      font-size: 0.85rem;
    }

    thead th,
    tbody td {
      padding: 0.5rem !important;
    }
  }

  /* Effet de focus */
  .accordion-button:focus {
    border-color: currentColor;
    box-shadow: none;
  }

  /* Smooth transitions */
  * {
    transition: all 0.2s ease;
  }
</style>

<!-- ================================================================ -->
<!-- JAVASCRIPT ÉVÉNEMENTS -->
<!-- ================================================================ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[ThemedGlobalStats] Initialisation');

    // Gestion du dépliage des objectifs
    const collapseButtons = document.querySelectorAll('.secteur-collapse-btn-themed');

    collapseButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.stopPropagation();

        const axeId = this.getAttribute('data-axe-id');
        const secteurId = this.getAttribute('data-secteur-id');
        const detailsId = `details-themed-axe${axeId}-secteur${secteurId}`;
        const detailsRow = document.getElementById(detailsId);
        const sectionRow = this.closest('.secteur-row-themed');
        const icon = this.querySelector('i');

        if (detailsRow) {
          const isVisible = detailsRow.style.display !== 'none';
          detailsRow.style.display = isVisible ? 'none' : 'table-row';

          if (isVisible) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            sectionRow.classList.remove('expanded');
          } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            sectionRow.classList.add('expanded');
          }
        }
      });
    });

    // Dépliage par clic sur la ligne
    const toggles = document.querySelectorAll('.secteur-toggle-themed');

    toggles.forEach(toggle => {
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const button = this.closest('.secteur-row-themed').querySelector('.secteur-collapse-btn-themed');
        if (button) button.click();
      });
    });

    console.log('[ThemedGlobalStats] Prêt');
  });
</script>

<!----****************************************Fin Statistiques par Axes,Secteurs et Objectifs *******************-->


<!-- ============================================= -->
<!-- NOUVEAU: SECTION DES AXES SOUS FORME DE PANNEAUX CLIQUABLES -->
<!-- ============================================= -->
<div class="row mt-2">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-sitemap me-2"></i>Axes de Projets
        </h5>
        <span class="badge bg-primary rounded-pill"><%= axesWithStats.length %> axes</span>
      </div>
      <div class="card-body">
        <!-- Panneaux des axes -->
        <div class="row" id="axes-panels">
          <% axesWithStats.forEach(function(axe, index) { %>
          <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 axe-card" data-axe-id="<%= axe.id %>" data-axe-name="<%= axe.lib_axe %>" style="cursor: pointer; transition: all 0.3s ease;">
              <div class="card-header bg-gradient-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="card-title mb-0">
                    <i class="fas fa-folder me-2"></i>Axe <%= axe.id %>
                  </h6>
                  <span class="badge bg-light text-primary rounded-pill">
                    <%= axe.nb_projets %> projet<%= axe.nb_projets > 1 ? 's' : '' %>
                  </span>
                </div>
              </div>
              <div class="card-body">
                <h6 class="text-primary mb-3"><%= axe.lib_axe %></h6>
                <div class="row text-center">
                  <div class="col-6 border-end">
                    <div class="text-success fw-bold fs-5">
                      <%= axe.cout_total.toFixed(1) %>M
                      <br><span class="badge bg-success ms-1" style="font-size: 1rem; vertical-align: middle;">
                        <%= axe.pourcentage %>%
                      </span>
                    </div>
                    <small class="text-muted">MDH</small>
                  </div>
                  <div class="col-6">
                    <div class="text-info fw-bold fs-5"><%= axe.total_emplois.toLocaleString() %></div>
                    <small class="text-muted">Emplois</small>
                  </div>
                </div>
                <div class="row text-center mt-2">
                  <div class="col-12">
                    <div class="text-warning fw-bold fs-6"><%= axe.total_beneficiaires.toLocaleString() %></div>
                    <small class="text-muted">Bénéficiaires</small>
                  </div>
                </div>
              </div>
              <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    <i class="fas fa-building me-1"></i><%= axe.lib_pole %>
                  </small>
                  <button class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye me-1"></i>Voir projets
                  </button>
                </div>
              </div>
            </div>
          </div>
          <% }); %>
        </div>

        <!-- Zone d'affichage des projets sélectionnés -->
        <div id="selected-axe-projects" class="mt-4" style="display: none;">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                <i class="fas fa-list me-2"></i>Projets de l'axe : <span id="selected-axe-title"></span>
              </h6>
              <button class="btn btn-sm btn-light" id="close-projects-view">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="card-body">
              <!-- Loading spinner -->
              <div id="projects-loading" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2 text-muted">Chargement des projets...</p>
              </div>

              <!-- Zone d'affichage des projets -->
              <div id="projects-container">
                <!-- Les projets seront chargés ici via AJAX -->
              </div>

              <!-- Message si aucun projet -->
              <div id="no-projects-message" class="text-center py-4" style="display: none;">
                <i class="fas fa-info-circle text-info fs-1"></i>
                <p class="mt-2 text-muted">Aucun projet trouvé pour cet axe</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================= -->
<!-- NOUVEAU: SECTION DES INSTRUCTIONS AVEC ACTIONS désctiver pour le moment-->
<!-- ============================================= 
<div class="row mt-2">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <h5 class="mb-0 me-3">
            <i class="fas fa-tasks me-2"></i>Gestion des Instructions
          </h5>
          <!-- Statistiques des instructions 
          <div class="d-flex gap-3">
            <span class="badge bg-success rounded-pill">
              <i class="fas fa-check me-1"></i><%= instructionStats.executed %> Exécutées
            </span>
            <span class="badge bg-warning rounded-pill">
              <i class="fas fa-clock me-1"></i><%= instructionStats.in_progress %> En cours
            </span>
            <span class="badge bg-danger rounded-pill">
              <i class="fas fa-exclamation-triangle me-1"></i><%= instructionStats.overdue %> En retard
            </span>
          </div>
        </div>

        <!-- Boutons d'action 
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-success" id="btn-add-instruction">
            <i class="fas fa-plus me-1"></i>Nouvelle instruction
          </button>
          <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-filter me-1"></i>Filtrer
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" data-filter="all">Toutes les instructions</a></li>
            <li><a class="dropdown-item" href="#" data-filter="executed">Exécutées</a></li>
            <li><a class="dropdown-item" href="#" data-filter="in_progress">En cours</a></li>
            <li><a class="dropdown-item" href="#" data-filter="overdue">En retard</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <div class="px-3 py-2">
                <input type="text" class="form-control form-control-sm" id="search-instructions" placeholder="Rechercher...">
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <!-- Table des instructions 
        <div class="table-responsive">
          <table class="table table-striped" id="instructions-table">
            <thead>
              <tr>
                <th>Numéro</th>
                <th>Sujet</th>
                <th>Destinataire</th>
                <th>Date limite</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="instructions-tbody">
              <% recentInstructions.forEach(function(instruction) { %>
              <tr data-instruction-id="<%= instruction.id %>" data-status="<%= instruction.statut_id %>">
                <td>
                  <span class="fw-bold"><%= instruction.num_instruction %></span>
                  <br>
                  <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    <%= new Date(instruction.date_instruction).toLocaleDateString('fr-FR') %>
                  </small>
                </td>
                <td>
                  <div class="fw-bold"><%= instruction.sujet %></div>
                  <% if (instruction.observations) { %>
                  <small class="text-muted">
                    <i class="fas fa-comment me-1"></i><%= instruction.observations.substring(0, 50) %>...
                  </small>
                  <% } %>
                </td>
                <td>
                  <div>
                    <i class="fas fa-user me-1"></i>
                    <%= instruction.destinataire_nom %> <%= instruction.destinataire_prenom %>
                  </div>
                </td>
                <td>
                  <span class="<%= instruction.status_color === 'danger' ? 'text-danger fw-bold' : instruction.status_color === 'warning' ? 'text-warning' : 'text-success' %>">
                    <i class="fas fa-calendar-alt me-1"></i>
                    <%= new Date(instruction.date_limite).toLocaleDateString('fr-FR') %>
                  </span>
                  <% if (instruction.date_execution) { %>
                  <br>
                  <small class="text-success">
                    <i class="fas fa-check me-1"></i>
                    Exécutée le <%= new Date(instruction.date_execution).toLocaleDateString('fr-FR') %>
                  </small>
                  <% } %>
                </td>
                <td>
                  <span class="badge bg-<%= instruction.status_color %>">
                    <% if (instruction.lib_statut === 'Exécuté') { %>
                    <i class="fas fa-check me-1"></i>
                    <% } else if (instruction.lib_statut === 'En Cours') { %>
                    <i class="fas fa-clock me-1"></i>
                    <% } else { %>
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <% } %>
                    <%= instruction.lib_statut %>
                  </span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <% if (instruction.lib_statut !== 'Exécuté') { %>
                    <!-- Bouton modifier 
                    <button type="button" class="btn btn-outline-primary btn-edit-instruction" data-instruction-id="<%= instruction.id %>" title="Modifier l'instruction">
                      <i class="fas fa-edit"></i>
                    </button>
                    <!-- Bouton supprimer 
                    <button type="button" class="btn btn-outline-danger btn-delete-instruction" data-instruction-id="<%= instruction.id %>" data-instruction-title="<%= instruction.sujet %>" title="Supprimer l'instruction">
                      <i class="fas fa-trash"></i>
                    </button>
                    <% } %>
                    <!-- Bouton voir détails 
                    <button type="button" class="btn btn-outline-info btn-view-instruction" data-instruction-id="<%= instruction.id %>" title="Voir les détails">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <% }); %>

              <% if (recentInstructions.length === 0) { %>
              <tr>
                <td colspan="6" class="text-center py-4">
                  <i class="fas fa-info-circle text-muted fs-1"></i>
                  <p class="mt-2 text-muted">Aucune instruction trouvée</p>
                  <button class="btn btn-primary" id="btn-add-first-instruction">
                    <i class="fas fa-plus me-1"></i>Créer votre première instruction
                  </button>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================= -->
<!-- MODALS -->
<!-- ============================================= 
<!-- Modal de confirmation de suppression d'instruction 
<div class="modal fade" id="deleteInstructionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirmer la suppression
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer cette instruction ?</p>
        <div class="alert alert-warning">
          <strong id="instruction-to-delete-title"></strong>
        </div>
        <p class="text-danger"><i class="fas fa-warning me-1"></i>Cette action est irréversible.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-instruction">
          <i class="fas fa-trash me-1"></i>Supprimer
        </button>
      </div>
    </div>
  </div>
</div> -->

<!-- ============================================= -->
<!-- SCRIPTS JAVASCRIPT -->
<!-- ============================================= -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // =============================================
    // GESTION DES PANNEAUX D'AXES CLIQUABLES
    // =============================================
    const axeCards = document.querySelectorAll('.axe-card');
    const selectedAxeProjectsSection = document.getElementById('selected-axe-projects');
    const selectedAxeTitle = document.getElementById('selected-axe-title');
    const projectsContainer = document.getElementById('projects-container');
    const projectsLoading = document.getElementById('projects-loading');
    const noProjectsMessage = document.getElementById('no-projects-message');
    const closeProjectsView = document.getElementById('close-projects-view');

    // Ajouter les effets hover sur les cartes d'axes
    axeCards.forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
        this.style.boxShadow = '0 8px 25px rgba(0,123,255,0.15)';
      });

      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '';
      });

      // Gérer le clic sur une carte d'axe
      card.addEventListener('click', function() {
        const axeId = this.dataset.axeId;
        const axeName = this.dataset.axeName;
        loadProjectsByAxe(axeId, axeName);
      });
    });

    // ==========================================
    // FONCTION POUR CHARGER LES PROJETS PAR AXE
    // ==========================================
    async function loadProjectsByAxe(axeId, axeName) {
      try {
        console.log('=== DEBUG loadProjectsByAxe ===');
        console.log('1. axeId:', axeId);
        console.log('2. axeName:', axeName);

        // Réinitialiser l'état d'affichage
        selectedAxeTitle.textContent = axeName;
        selectedAxeProjectsSection.style.display = 'block';
        projectsLoading.style.display = 'block';
        projectsContainer.innerHTML = '';
        noProjectsMessage.style.display = 'none';

        // Faire défiler vers la section des projets
        selectedAxeProjectsSection.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });

        console.log('3. URL de la requête:', `/dashboard/api/projets-by-axe/${axeId}`);

        // Appel AJAX pour récupérer les projets
        const response = await fetch(`/dashboard/api/projets-by-axe/${axeId}`);

        console.log('4. Status de la réponse:', response.status);
        console.log('5. Response OK?:', response.ok);

        const data = await response.json();

        console.log('6. Données reçues:', data);
        console.log('7. Success?:', data.success);
        console.log('8. Nombre de projets:', data.data ? data.data.length : 0);

        projectsLoading.style.display = 'none';

        if (data.success && data.data && data.data.length > 0) {
          console.log('9. Affichage des projets...');
          displayProjects(data.data);
        } else {
          console.log('10. Aucun projet trouvé');
          noProjectsMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('=== ERREUR loadProjectsByAxe ===');
        console.error('Erreur complète:', error);
        console.error('Stack:', error.stack);

        projectsLoading.style.display = 'none';
        projectsContainer.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Erreur lors du chargement des projets: ${error.message}
            <br>
            <small>Veuillez réessayer ou contacter l'administrateur.</small>
          </div>
        `;
      }
    }

    // ==========================================
    // FONCTION POUR AFFICHER LES PROJETS
    // ==========================================
    function displayProjects(projects) {
      const projectsHtml = `
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>N°</th>
                <th>Intitulé</th>
                <th>Secteur</th>
                <th>Coût (MDH)</th>
                <th>Emplois</th>
                <th>Période</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${projects.map(project => `
                <tr>
                  <td>
                    <span class="badge bg-primary">${project.num_projet}</span>
                  </td>
                  <td>
                    <div class="fw-bold text-truncate" style="max-width: 300px;" title="${project.intitule}">
                      ${project.intitule}
                    </div>
                  </td>
                  <td>
                    <small class="text-muted">${project.lib_secteur}</small>
                  </td>
                  <td>
                    <span class="fw-bold text-success">
                      ${project.cout_total_mdh ? parseFloat(project.cout_total_mdh).toFixed(2) : '0.00'}
                    </span>
                  </td>
                  <td>
                    <span class="text-info">
                      ${project.nbr_emplois_directs || 0}
                    </span>
                  </td>
                  <td>
                    <small class="text-muted">
                      ${project.annee_debut ? project.annee_debut : ''}
                      ${project.annee_fin ? '- ' + project.annee_fin : ''}
                    </small>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary btn-view-project"
                            data-project-id="${project.id}"
                            title="Voir les détails du projet">
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      projectsContainer.innerHTML = projectsHtml;

      // Ajouter les événements pour les boutons "voir projet"
      const viewProjectButtons = projectsContainer.querySelectorAll('.btn-view-project');
      viewProjectButtons.forEach(button => {
        button.addEventListener('click', function() {
          const projectId = this.dataset.projectId;
          // Ajouter le paramètre axe=true pour indiquer qu'on vient du dashboard
          window.location.href = `/projects/view/${projectId}?axe=true`;
        });
      });
    }

    // Bouton pour fermer la vue des projets
    closeProjectsView.addEventListener('click', function() {
      selectedAxeProjectsSection.style.display = 'none';
    });

    // =============================================
    // GESTION DES INSTRUCTIONS (Si activé)
    // =============================================

    // Boutons d'ajout d'instruction
    const btnAddInstruction = document.getElementById('btn-add-instruction');
    const btnAddFirstInstruction = document.getElementById('btn-add-first-instruction');

    if (btnAddInstruction) {
      btnAddInstruction.addEventListener('click', function() {
        window.location.href = '/instructions/add';
      });
    }

    if (btnAddFirstInstruction) {
      btnAddFirstInstruction.addEventListener('click', function() {
        window.location.href = '/instructions/add';
      });
    }

    // Gestion des filtres d'instructions
    const filterDropdownItems = document.querySelectorAll('.dropdown-item[data-filter]');
    const searchInstructions = document.getElementById('search-instructions');

    filterDropdownItems.forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const filter = this.dataset.filter;
        filterInstructions(filter);
      });
    });

    // Fonction pour filtrer les instructions
    function filterInstructions(filter) {
      const rows = document.querySelectorAll('#instructions-tbody tr[data-instruction-id]');
      rows.forEach(row => {
        const status = row.dataset.status;
        let shouldShow = true;

        switch (filter) {
          case 'executed':
            shouldShow = status === '1';
            break;
          case 'in_progress':
            shouldShow = status === '2';
            break;
          case 'overdue':
            shouldShow = status === '3';
            break;
          case 'all':
          default:
            shouldShow = true;
            break;
        }

        row.style.display = shouldShow ? '' : 'none';
      });
    }

    // Recherche en temps réel dans les instructions
    if (searchInstructions) {
      searchInstructions.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#instructions-tbody tr[data-instruction-id]');

        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      });
    }

    // =============================================
    // GESTION DES ACTIONS SUR LES INSTRUCTIONS
    // =============================================

    document.addEventListener('click', function(e) {
      if (e.target.closest('.btn-edit-instruction')) {
        const instructionId = e.target.closest('.btn-edit-instruction').dataset.instructionId;
        window.location.href = `/instructions/edit/${instructionId}`;
      }

      if (e.target.closest('.btn-view-instruction')) {
        const instructionId = e.target.closest('.btn-view-instruction').dataset.instructionId;
        window.location.href = `/instructions/view/${instructionId}`;
      }

      if (e.target.closest('.btn-delete-instruction')) {
        const button = e.target.closest('.btn-delete-instruction');
        const instructionId = button.dataset.instructionId;
        const instructionTitle = button.dataset.instructionTitle;

        document.getElementById('instruction-to-delete-title').textContent = instructionTitle;
        document.getElementById('confirm-delete-instruction').dataset.instructionId = instructionId;

        const modal = new bootstrap.Modal(document.getElementById('deleteInstructionModal'));
        modal.show();
      }
    });

    // Confirmation de suppression d'instruction
    const confirmDeleteInstruction = document.getElementById('confirm-delete-instruction');
    if (confirmDeleteInstruction) {
      confirmDeleteInstruction.addEventListener('click', async function() {
        const instructionId = this.dataset.instructionId;

        try {
          const response = await fetch(`/instructions/delete/${instructionId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();

          if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('deleteInstructionModal')).hide();

            const row = document.querySelector(`tr[data-instruction-id="${instructionId}"]`);
            if (row) {
              row.remove();
            }

            showToast('Instruction supprimée avec succès', 'success');
          } else {
            showToast('Erreur lors de la suppression: ' + result.message, 'error');
          }
        } catch (error) {
          console.error('Erreur lors de la suppression:', error);
          showToast('Une erreur est survenue lors de la suppression', 'error');
        }
      });
    }

    // =============================================
    // FONCTIONS UTILITAIRES
    // =============================================

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container') || createToastContainer();

      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
      toast.setAttribute('role', 'alert');

      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;

      toastContainer.appendChild(toast);

      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
      });
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '1055';
      document.body.appendChild(container);
      return container;
    }

  }); // FIN DU DOMContentLoaded
</script>

<style>
  /* Styles CSS personnalisés pour le dashboard gouverneur */
  .axe-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
  }

  .bg-gradient-primary {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
  }

  .btn-group-sm>.btn,
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.2rem;
  }

  #selected-axe-projects {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }

  .text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .toast-container {
    z-index: 1055;
  }
</style>

<style>
  /* Styles CSS personnalisés pour le dashboard gouverneur */
  .axe-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
  }

  .bg-gradient-primary {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
  }

  .btn-group-sm>.btn,
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.2rem;
  }

  #selected-axe-projects {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }

  .text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .toast-container {
    z-index: 1055;
  }
</style>